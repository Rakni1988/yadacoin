<div id="PoolBlocksContent"></div>
    <div class="column">
        <div class="box">
          <img src="yadacoinpoolstatic/img/blockchain-blocks.png" alt="Dashboard Watermark" class="watermark">
            <h5><b>BLOCKS FOUND</b></h5>
            <div id="blocks-found"></div>
        </div>
    </div>
    <div class="column">
        <div class="box">
            <img src="yadacoinpoolstatic/img/blockchain-blocks.png" alt="Dashboard Watermark" class="watermark">
            <h5><b>LAST POOL BLOCK</b></h5>
            <div id="last-block"></div>
            <h5 id="last-block-time"></h5>
        </div>
    </div>
    <div class="column">
        <div class="box">
            <img src="yadacoinpoolstatic/img/block-check.png" alt="Dashboard Watermark" class="watermark">
            <h5><b>MATURITY REQUIREMENT</b></h5>
            <div id="maturity"></div>
        </div>
    </div>
    <div class="column">
        <div class="box">
          <img src="yadacoinpoolstatic/img/luck.png" alt="Dashboard Watermark" class="watermark">
            <h5><b>AVARAGE LUCK</b></h5>
            <div id="avg-effort"></div>
        </div>
    </div>
    <div style="font-size: 24px;">Blocks found in the last 30 days</div>
    <div id="chart-container" style="margin-bottom: 20px;">
        <canvas id="myBarChart"></canvas>
    </div>
    <table id="blocks-table">
        <tr>
            <th>Time Found</th>
            <th>Difficulty</th>
            <th>Height</th>
            <th>Reward</th>
            <th>Block Hash</th>
            <th>Finder</th>
            <th>Effort</th>
            <th>Status</th>
        </tr>
    </table>
    <center><button class="button" id="loadMore">Load More Blocks</button></center>
</div>


<script>
  $.get('/pool-info').then((poolInfoData) => {
      $('#blocks-found').html(poolInfoData.pool.blocks_found);

      if (poolInfoData.pool.last_five_blocks.length > 0) {
          var newDate = new Date();
          newDate.setTime(poolInfoData.pool.last_five_blocks[0].timestamp * 1000);
          var dateString = newDate.toLocaleString();
          $('#last-block').html(poolInfoData.pool.last_five_blocks[0].height);
          $('#last-block-time').html(dateString);
      }
  });

  if (typeof blockPageIndex === 'undefined') {
      var blockPageIndex = 1;
  }

  if (typeof blockPageSize === 'undefined') {
      var blockPageSize = 10;
  }

  function updatePoolBlocksData(blockPageIndex) {
    const max_target_hex = '0x0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF';
    const max_target = parseInt(max_target_hex, 16);

    $.get(`/pool-blocks?page=${blockPageIndex}&page_size=${blockPageSize}`).then((data) => {
      $('#maturity').html(data.pool_info.block_confirmation);

      if (data.blocks.length === 0) return $('#blocks-table').html('<tr><th>Time Found</th><th>Difficulty</th><th>Height</th><th>Reward</th><th>Finder</th><th>Effort</th><th>Block Hash</th><th>Status</th></tr>');

      for (var i = 0; i < data.blocks.length; i++) {
        var newDate = new Date();
        newDate.setTime(data.blocks[i].found_time * 1000);
        var foundDateString = newDate.toLocaleString();

        var reward = data.blocks[i].reward + " YDA" || 'N/A';
        var difficulty = "N/A";
        if (data.blocks[i].target) {
          var target = parseInt(data.blocks[i].target, 16);
          difficulty = (max_target / target).toFixed(3);
        }

        var effort = data.blocks[i].effort !== undefined ? parseFloat(data.blocks[i].effort).toFixed(2) + "%" : "N/A";
        var effortColor = getEffortColor(data.blocks[i].effort);

        $('#blocks-table').append('<tr><td>' + foundDateString + '</td><td>' + difficulty + '</td><td>' + data.blocks[i].index + '</td><td>' + reward + '</td><td><a target="_blank" href="/explorer?term=' + data.blocks[i].hash + '">' + data.blocks[i].hash + '</a></td><td>' + getMinerAddress(data.blocks[i].miner_address) + '</td><td style="color:' + effortColor + '">' + effort + '</td><td style="text-align: center;">' + getStatusIcon(data.blocks[i].status) + '</td></tr>');
      }
    });
  }

  function getEffortColor(effort) {
    if (effort > 155) {
      return 'red';
    } else if (effort > 105) {
      return 'orange';
    } else {
      return 'green';
    }
  }

  function getStatusIcon(status) {
    let statusIconPath = '';
    if (status === 'Pending') {
      statusIconPath = 'yadacoinpoolstatic/img/pending.png';
    } else if (status === 'Accepted') {
      statusIconPath = 'yadacoinpoolstatic/img/accept.png';
    } else if (status === 'Orphan') {
      statusIconPath = 'yadacoinpoolstatic/img/not_accept.png';
    }

    return '<img src="' + statusIconPath + '" alt="' + status + '" style="width: 20px; height: 20px;" />';
  }

  function getMinerAddress(minerAddress) {
    if (minerAddress && minerAddress.length >= 16) {
      return minerAddress.substring(0, 5) + '.....' + minerAddress.slice(-10);
    }
    return 'Unknown';
  }

  $('#loadMore').click(function () {
    blockPageIndex++;
    updatePoolBlocksData(blockPageIndex);
  });

  updatePoolBlocksData(blockPageIndex);

  $.get('/pool-blocks-chart').then((chartData) => {
      const last30Days = [];
      const today = new Date();

      for (let i = 29; i >= 0; i--) {
          const day = new Date(today);
          day.setDate(today.getDate() - i);
          const formattedDate = day.toISOString().split('T')[0];
          last30Days.push(formattedDate);
      }

      const dateToBlockCount = {};
      const dateToAverageEffort = {};

      chartData.blocks_by_date.forEach(entry => {
          dateToBlockCount[entry._id] = entry.count;
          dateToAverageEffort[entry._id] = entry.average_effort;
      });

      const dates = last30Days;
      const blockCounts = dates.map(date => dateToBlockCount[date] || 0);
      const averageEfforts = dates.map(date => dateToAverageEffort[date] || 0);

      $('#pool-luck').html(chartData.total_effort.toFixed(2) + ' %');
      $('#avg-effort').html(chartData.average_effort.toFixed(2) + ' %');
      
      createCombinedChart(dates, blockCounts, averageEfforts);
  });

  function createCombinedChart(dates, blockCounts, averageEfforts) {
      const ctx = document.getElementById('myBarChart').getContext('2d');

      new Chart(ctx, {
          type: 'bar',
          data: {
              labels: dates,
              datasets: [
                  {
                      label: 'Average Effort',
                      data: averageEfforts,
                      type: 'line',
                      borderColor: '#007bff',
                      backgroundColor: 'rgba(0, 123, 255, 0.2)',
                      fill: false,
                      yAxisID: 'y1'
                  },
                  {
                      label: 'Blocks found by pool',
                      data: blockCounts,
                      backgroundColor: '#A9A9A9',
                      borderColor: '#404040',
                      borderWidth: 1,
                      yAxisID: 'y'
                  }
              ]
          },
          options: {
              scales: {
                  y: {
                      beginAtZero: true,
                      position: 'left'
                  },
                  y1: {
                      beginAtZero: true,
                      position: 'right',
                      grid: {
                          drawOnChartArea: false
                      }
                  }
              },
              maintainAspectRatio: false
          }
      });
  }

</script>

