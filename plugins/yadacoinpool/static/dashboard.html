<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Node Status Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .status-ok { color: green; }
        .status-fail { color: red; }
        .flex-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .left-panel {
            width: 40%;
        }

        .right-panel {
            width: 58%;
        }
        #log-container {
            background-color: black;
            color: white;
            font-family: monospace;
            padding: 10px;
            height: 400px;
            overflow-y: scroll;
            border-radius: 5px;
            border: 1px solid #333;
            white-space: pre-wrap;
        }
        .log-info { color: #00ff00; }
        .log-warning { color: #ffff00; }
        .log-error { color: #ff0000; }

    </style>
</head>
<body>
    <h2>Node Status Dashboard</h2>

    <div class="flex-container">
        <div class="left-panel">
            <h3>Node Information</h3>
            <table id="node-info" border="1"></table>

            <h3>Performance Metrics</h3>
            <table id="performance-info" border="1"></table>
        </div>

        <div class="right-panel">
            <h3>Health Status</h3>
            <table id="health-status" border="1"></table>
        </div>
    </div>

    <h3>Application Logs</h3>
    <pre id="log-container">Loading logs...</pre>

    <h3>Peer Connections</h3>
    <table id="peer-connections" border="1"></table>

    <script>
        async function fetchNodeStatus() {
            const response = await fetch('/get-status'); // API endpoint
            const nodeStatus = await response.json();
            
            // Node Info
            const nodeInfoTable = document.getElementById('node-info');
            nodeInfoTable.innerHTML = `
                <tr><th>Version</th><td>${nodeStatus.version}</td></tr>
                <tr><th>Protocol</th><td>${nodeStatus.protocol_version}</td></tr>
                <tr><th>Network</th><td>${nodeStatus.network}</td></tr>
                <tr><th>Uptime</th><td>${nodeStatus.uptime}</td></tr>
                <tr><th>Block Height</th><td>${nodeStatus.height}</td></tr>
                <tr><th>Synced</th><td>${nodeStatus.synced ? "✅ Yes" : "❌ No"}</td></tr>
            `;

            // Performance Metrics
            const performanceTable = document.getElementById('performance-info');
            performanceTable.innerHTML = `
                <tr><th>Queue</th><th>Items in Queue</th><th>Avg Processing Time</th><th>Processed Items</th></tr>
            `;
            
            for (const [key, value] of Object.entries(nodeStatus.processing_queues)) {
                performanceTable.innerHTML += `
                    <tr>
                        <td>${key}</td>
                        <td>${value.queue_item_count}</td>
                        <td>${value.average_processing_time} sec</td>
                        <td>${value.num_items_processed}</td>
                    </tr>
                `;
            }

            // Health Status
            const healthTable = document.getElementById('health-status');
            healthTable.innerHTML = '<tr><th>Service</th><th>Status</th><th>Time Until Fail</th><th>Ignored</th></tr>';
            for (const [key, value] of Object.entries(nodeStatus.health)) {
                if (typeof value === 'object') {
                    const cleanKeys = Object.keys(value).reduce((acc, k) => {
                        acc[k.trim()] = value[k];
                        return acc;
                    }, {});

                    const status = cleanKeys["status"];
                    const ignored = cleanKeys["ignore"];
                    const displayStatus = ignored ? '⚠️ Ignored' : (status ? "✅ OK" : "❌ Failed");

                    healthTable.innerHTML += `
                        <tr>
                            <td>${key}</td>
                            <td class="${status ? 'status-ok' : (ignored ? 'status-ignored' : 'status-fail')}">${displayStatus}</td>
                            <td>${cleanKeys["time_until_fail"]} sec</td>
                            <td>${ignored ? 'Yes' : 'No'}</td>
                        </tr>
                    `;
                }
            }


            // Peer Connections
            const peerResponse = await fetch('/get-peers');
            const peerStatus = await peerResponse.json();
            const peerTable = document.getElementById('peer-connections');

            peerTable.innerHTML = '<tr><th>Host</th><th>Port</th><th>Type</th><th>Version</th><th>Connected</th></tr>';

            peerStatus.outbound_peers.forEach(peer => {
                const version = peer.node_version ? peer.node_version.join('.') : "Unknown";

                peerTable.innerHTML += `
                    <tr>
                        <td>${peer.host}</td>
                        <td>${peer.port}</td>
                        <td>${peer.peer_type || "Unknown"}</td>
                        <td>${version}</td>
                        <td>${peer.connection_duration || "N/A"}</td>
                    </tr>
                `;
            });

        }

        fetchNodeStatus();
        setInterval(fetchNodeStatus, 30000);

        function fetchLogs() {
            fetch('/get-logs')
            .then(response => response.text())
            .then(data => {
                let logContainer = document.getElementById("log-container");
                let lines = data.split("\n");
                let formattedLogs = "";

                lines.forEach(line => {
                    let className = "log-default";
                    if (line.includes("INFO")) className = "log-info";
                    if (line.includes("WARNING")) className = "log-warning";
                    if (line.includes("ERROR")) className = "log-error";

                    formattedLogs += `<div class="${className}">${line}</div>`;
                });

                logContainer.innerHTML = formattedLogs;
                logContainer.scrollTop = logContainer.scrollHeight; // Auto-scroll
            })
            .catch(error => console.error('Error fetching logs:', error));
        }

        setInterval(fetchLogs, 30000);
        fetchLogs();

    </script>
</body>
</html>
